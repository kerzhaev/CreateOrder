# Технический план: Массовое добавление сотрудников на лист "Выплаты_Без_Периодов"

**Версия:** 1.0.0  
**Дата:** 02.01.2025  
**Автор:** Кержаев Евгений, ФКУ "95 ФЭС" МО РФ  
**Ссылка на спецификацию:** `.spec/mass-employee-import.md`

## 1. Обзор изменений

Добавляются две функциональности:
1. **Массовое добавление сотрудников** - автоматическое заполнение ФИО по личным/табельным номерам
2. **Выбор сотрудника через форму поиска** - форма для выбора сотрудника и заполнения текущей строки

## 2. Затронутые файлы

### 2.1. Модули VBA (расширение существующих)
- `mdlHelper.bas` - добавление функций поиска по табельному номеру
- `mdlUniversalPaymentExport.bas` - добавление функции массового импорта
- `mdlRibbonHandlers.bas` - добавление обработчиков кнопок Ribbon

### 2.2. Новые файлы
- `frmSelectEmployee.frm` - форма выбора сотрудника (UserForm)
- `frmSelectEmployee.frx` - бинарный файл формы (создается автоматически Excel)

### 2.3. Обновление Ribbon XML
- `resources/customUI14.xml` - добавление кнопок "Массовое добавление" и "Выбрать сотрудника"

## 3. Детальный план изменений

### Этап 1: Расширение `mdlHelper.bas`

#### 1.1. Добавление функции поиска колонки "Лицо"
**Функция:** `FindTableNumberColumn(ws As Worksheet) As Long`
- Поиск колонки с заголовком "Лицо" в первой строке листа "Штат"
- Возвращает номер колонки или 0, если не найдена

#### 1.2. Добавление функции поиска по табельному номеру
**Функция:** `GetStaffDataByTableNumber(tableNumber As String) As Object`
- Поиск сотрудника по табельному номеру (колонка "Лицо")
- Возвращает Dictionary с теми же ключами, что и `GetStaffData()`
- Использует `FindTableNumberColumn()` для определения колонки
- Структура аналогична `GetStaffData()`

#### 1.3. Добавление универсальной функции поиска
**Функция:** `FindEmployeeByAnyNumber(number As String) As Object`
- Сначала пытается найти по личному номеру через `GetStaffData(number, True)`
- Если не найдено, пытается найти по табельному номеру через `GetStaffDataByTableNumber(number)`
- Возвращает Dictionary с данными или пустой Dictionary

**Расположение функций:** В конце модуля `mdlHelper.bas`, после существующих функций работы со штатом

---

### Этап 2: Расширение `mdlUniversalPaymentExport.bas`

#### 2.1. Добавление функции массового импорта
**Функция:** `ImportEmployeesByNumbers()`
- Главная функция массового импорта
- Проверяет активный лист (должен быть "Выплаты_Без_Периодов")
- Получает выделенный диапазон (Selection)
- Вызывает `ProcessSelectedRangeForImport()` для обработки
- Показывает отчет о результатах

#### 2.2. Добавление функции обработки диапазона
**Функция:** `ProcessSelectedRangeForImport(wsPayments As Worksheet, selectedRange As Range) As String`
- Обрабатывает выделенный диапазон ячеек
- Для каждой ячейки:
  - Извлекает номер (Trim, очистка от лишних пробелов)
  - Если пусто - пропускает
  - Вызывает `mdlHelper.FindEmployeeByAnyNumber()` для поиска
  - Если найден - заполняет колонку C (ФИО) и обновляет колонку D (личный номер)
  - Если не найден - добавляет в список не найденных
- Подсчитывает статистику (найдено/не найдено)
- Возвращает строку с отчетом

**Обработка перезаписи:** Всегда перезаписывает ФИО (даже если уже заполнено)

**Расположение функций:** В начале модуля, после констант (если есть), перед функциями экспорта

---

### Этап 3: Создание формы `frmSelectEmployee.frm`

#### 3.1. Структура формы
**Элементы управления:**
- `txtSearch` (TextBox) - поле поиска
- `lstResults` (ListBox) - список результатов (ColumnCount = 4)
- `lblStatus` (Label) - статус (количество найденных)
- `lblFIO` (Label) - ФИО выбранного сотрудника
- `lblZvanie` (Label) - звание
- `lblDolzhnost` (Label) - должность
- `btnSelect` (CommandButton) - кнопка "Выбрать"
- `btnCancel` (CommandButton) - кнопка "Отмена"

#### 3.2. Публичные переменные
```vba
Public selectedLichniyNomer As String
Public selectedFIO As String
Public isCancelled As Boolean
```

#### 3.3. События формы
- `UserForm_Initialize()` - инициализация формы, настройка ListBox
- `txtSearch_Change()` - обработка изменения текста поиска
  - Поиск по ФИО, личному номеру, табельному номеру
  - Отображение результатов в ListBox (4 колонки: личный номер, ФИО, звание, должность)
- `lstResults_Click()` - обработка клика по списку (показать детали выбранного)
- `lstResults_DblClick()` - обработка двойного клика (выбор сотрудника)
- `btnSelect_Click()` - обработка кнопки "Выбрать"
- `btnCancel_Click()` - обработка кнопки "Отмена"

**Примечание:** Форма создается как упрощенная версия `frmSearchFIO` (без периодов, с минимальным набором полей)

**Поиск:** Реализовать поиск по ФИО (частичное совпадение), личному номеру (точное и частичное), табельному номеру (точное совпадение)

---

### Этап 4: Расширение `mdlRibbonHandlers.bas`

#### 4.1. Добавление обработчика массового импорта
**Функция:** `OnMassImportEmployeesClick(control As IRibbonControl)`
- Проверяет активный лист
- Если лист = "Выплаты_Без_Периодов", вызывает `mdlUniversalPaymentExport.ImportEmployeesByNumbers()`
- Если лист другой - показывает предупреждение

#### 4.2. Добавление обработчика выбора сотрудника
**Функция:** `OnSelectEmployeeClick(control As IRibbonControl)`
- Проверяет активный лист (должен быть "Выплаты_Без_Периодов")
- Проверяет активную ячейку (должна быть в колонке C или D)
- Определяет целевую строку
- Открывает форму `frmSelectEmployee`
- После закрытия формы, если выбор сделан - заполняет ячейки C и D

**Расположение функций:** В конце модуля, после существующих обработчиков

---

### Этап 5: Обновление Ribbon XML

#### 5.1. Добавление кнопок в группу "Надбавки"
В файле `resources/customUI14.xml` добавить две кнопки:

**Кнопка "Массовое добавление":**
```xml
<button id="massImportEmployees" 
        label="Массовое добавление" 
        onAction="OnMassImportEmployeesClick" 
        imageMso="PeopleAddToTeam"
        size="normal"
        screentip="Массовое добавление сотрудников"
        supertip="Выделите ячейки с номерами в колонке D и нажмите для автоматического заполнения ФИО"/>
```

**Кнопка "Выбрать сотрудника":**
```xml
<button id="selectEmployee" 
        label="Выбрать сотрудника" 
        onAction="OnSelectEmployeeClick" 
        imageMso="PeoplePicker"
        size="normal"
        screentip="Выбрать сотрудника из списка"
        supertip="Открывает форму поиска для выбора сотрудника и заполнения текущей строки"/>
```

**Расположение:** В группе "allowancesGroup", после существующих кнопок

---

## 4. Алгоритмы реализации

### 4.1. Алгоритм поиска по табельному номеру
```
1. Найти колонку "Лицо" в листе "Штат" (поиск в первой строке)
2. Если колонка не найдена - вернуть пустой Dictionary
3. Пройти по всем строкам листа "Штат" (начиная со 2-й)
4. Сравнить значение в колонке "Лицо" с искомым номером (Trim, точное совпадение)
5. Если найдено - создать Dictionary с данными сотрудника (ФИО, личный номер, звание, должность, часть)
6. Вернуть Dictionary
```

### 4.2. Алгоритм массового импорта
```
1. Проверить активный лист (должен быть "Выплаты_Без_Периодов")
2. Получить выделенный диапазон (Selection)
3. Проверить, что диапазон находится в колонке D (COL_LICHNIY_NOMER)
4. Для каждой ячейки в диапазоне:
   a. Получить значение ячейки (Trim)
   b. Если пусто - пропустить
   c. Вызвать mdlHelper.FindEmployeeByAnyNumber() для поиска
   d. Если найден:
      - Заполнить колонку C (ФИО) = staffData("Лицо")
      - Обновить колонку D (личный номер) = staffData("Личный номер")
   e. Если не найден - добавить в список не найденных
5. Подсчитать статистику
6. Показать отчет пользователю
```

### 4.3. Алгоритм формы выбора сотрудника
```
1. При открытии формы:
   - Инициализировать ListBox (ColumnCount = 4)
   - Очистить результаты
   - Установить isCancelled = True

2. При изменении текста поиска (txtSearch_Change):
   - Получить запрос (Trim, LCase)
   - Если длина < 2 символов - показать подсказку
   - Иначе:
     a. Пройти по листу "Штат"
     b. Поиск по ФИО (частичное совпадение, InStr)
     c. Поиск по личному номеру (частичное совпадение, InStr)
     d. Поиск по табельному номеру (точное совпадение, если запрос - число)
     e. Добавить найденные результаты в ListBox

3. При клике по списку (lstResults_Click):
   - Получить выбранный элемент
   - Извлечь личный номер из первой колонки
   - Найти данные сотрудника и показать в полях (lblFIO, lblZvanie, lblDolzhnost)

4. При двойном клике или нажатии "Выбрать":
   - Установить selectedLichniyNomer и selectedFIO
   - Установить isCancelled = False
   - Закрыть форму (Hide)

5. При отмене:
   - Установить isCancelled = True
   - Закрыть форму (Hide)
```

---

## 5. Константы и зависимости

### 5.1. Использование существующих констант
- `mdlReferenceData.SHEET_PAYMENTS_NO_PERIODS` - имя листа "Выплаты_Без_Периодов"
- `mdlPaymentValidation.COL_FIO` - колонка ФИО (3)
- `mdlPaymentValidation.COL_LICHNIY_NOMER` - колонка личного номера (4)

### 5.2. Использование существующих функций
- `mdlHelper.FindColumnNumbers()` - для определения колонок листа "Штат"
- `mdlHelper.GetStaffData()` - для поиска по личному номеру
- `mdlHelper.EnsureStaffColumnsInitialized()` - для инициализации колонок (в форме)

---

## 6. Обработка ошибок

### 6.1. Массовый импорт
- **Лист не найден:** Показать сообщение, выйти
- **Диапазон не в колонке D:** Показать предупреждение, выйти
- **Номер не найден:** Продолжить обработку, добавить в отчет

### 6.2. Форма выбора
- **Лист "Штат" не найден:** Показать сообщение при инициализации
- **Активная ячейка не в колонке C или D:** Показать предупреждение, не открывать форму

---

## 7. Порядок реализации

1. **Этап 1:** Расширение `mdlHelper.bas` (функции поиска по табельному номеру)
2. **Этап 2:** Расширение `mdlUniversalPaymentExport.bas` (массовый импорт)
3. **Этап 3:** Создание формы `frmSelectEmployee.frm`
4. **Этап 4:** Расширение `mdlRibbonHandlers.bas` (обработчики)
5. **Этап 5:** Обновление Ribbon XML
6. **Этап 6:** Тестирование

---

## 8. Тестирование

### 8.1. Тестирование массового импорта
- Добавление одного номера (личный)
- Добавление одного номера (табельный)
- Добавление нескольких номеров
- Обработка несуществующих номеров
- Перезапись уже заполненного ФИО
- Обработка пустых ячеек в диапазоне

### 8.2. Тестирование формы поиска
- Поиск по ФИО (частичное совпадение)
- Поиск по личному номеру
- Поиск по табельному номеру
- Выбор сотрудника (кнопка и двойной клик)
- Отмена выбора
- Заполнение строки после выбора

---

## 9. Замечания

- Формат личного номера: 1-2 буквы + дефис + 6 цифр (МТ-145987, Х-258741)
- Валидация формата не требуется - поиск по точному/частичному совпадению
- Табельный номер - числовое значение в колонке "Лицо"
- Перезапись ФИО разрешена при массовом импорте
- Логирование операций не требуется

---

**Статус:** Готов к реализации  
**Следующий этап:** Реализация кода (Implementation)
