# Спецификация: Массовое добавление сотрудников на лист "Выплаты_Без_Периодов"

**Версия:** 1.0.0  
**Дата:** 02.01.2025  
**Автор:** Кержаев Евгений, ФКУ "95 ФЭС" МО РФ

## 1. Описание задачи (пользовательский сценарий)

Пользователь должен иметь возможность быстро добавлять сотрудников на лист "Выплаты_Без_Периодов" двумя способами:

### 1.1. Массовое добавление по номерам
**Сценарий:**
- Пользователь копирует список личных или табельных номеров сотрудников из внешнего источника (Excel, Word, текстовый файл и т.д.)
- Пользователь вставляет эти номера в колонку D (личный номер) листа "Выплаты_Без_Периодов"
- Пользователь запускает функцию массового заполнения
- Система автоматически:
  - Находит каждого сотрудника по личному/табельному номеру в листе "Штат"
  - Заполняет колонку C (ФИО) найденными данными
  - Оставляет пустыми колонки B (тип выплаты), E (размер), F (основание) для ручного заполнения

**Требования:**
- Поддержка вставки номеров в одну колонку (D) или в несколько ячеек
- Обработка номеров, разделенных пробелами, запятыми, переносами строк
- Обработка случаев, когда номер не найден в штате (вывод предупреждения, но продолжение работы)
- Автоматическая нумерация в колонке A (если пусто)

### 1.2. Добавление одного сотрудника через форму поиска
**Сценарий:**
- Пользователь находится на листе "Выплаты_Без_Периодов"
- Пользователь кликает на ячейку в колонке C (ФИО) или D (личный номер)
- Открывается форма поиска (аналогичная форме на листе ДСО)
- Пользователь вводит часть ФИО или личного номера
- Система показывает список найденных сотрудников
- Пользователь выбирает нужного сотрудника
- Система заполняет:
  - Колонку C (ФИО) - выбранным ФИО
  - Колонку D (личный номер) - выбранным личным номером
- Форма закрывается, пользователь может продолжить заполнение остальных полей

**Требования:**
- Форма должна быть аналогична `frmSearchFIO`, но упрощенной (без периодов)
- Поиск по ФИО, личному номеру, табельному номеру (колонка с названием Лицо, которое содержит только числовые значения)
- Отображение: личный номер, ФИО, звание, должность
- Двойной клик или кнопка "Выбрать" для подтверждения выбора

## 2. Функциональные требования

### 2.1. Массовое добавление
- **Входные данные:** Выделенный диапазон ячеек в колонке D (личный номер) листа "Выплаты_Без_Периодов"
- **Выходные данные:** Заполненные колонки C (ФИО) и D (личный номер) для найденных сотрудников
- **Обработка ошибок:**
  - Если номер не найден - оставить ячейку пустой, добавить в отчет
  - Если номер найден, но ФИО уже заполнено - перезаписать (возможность перезаписи предусмотрена)
  - Если номер дублируется в выделенном диапазоне - обработать все вхождения
- **Поддержка номеров:**
  - Личные номера (формат: 1-2 буквы + дефис + 6 цифр, например: МТ-145987, Х-258741)
  - Табельные номера (числовые значения из колонки "Лицо" листа "Штат")

### 2.2. Добавление через форму
- **Триггер:** Двойной клик или специальная кнопка на Ribbon для открытия формы
- **Входные данные:** Текущая активная ячейка (должна быть в колонке C или D)
- **Выходные данные:** Заполненные ячейки C и D в текущей строке
- **Обработка ошибок:**
  - Если активная ячейка не в нужной колонке - показать предупреждение
  - Если форма отменена - не изменять данные

## 3. Технические требования

### 3.1. Структура листа "Выплаты_Без_Периодов"
- Колонка A: Номер (автоматическая нумерация)
- Колонка B: Тип выплаты
- Колонка C: ФИО (заполняется автоматически)
- Колонка D: Личный номер (входные данные для массового добавления)
- Колонка E: Размер
- Колонка F: Основание

### 3.2. Структура листа "Штат"
- Используется существующая функция `mdlHelper.GetStaffData()` для поиска по личному номеру
- Поиск должен поддерживать как личные номера, так и табельные номера (колонка "Лицо" с числовыми значениями)
- Формат личного номера: 1-2 буквы + дефис + 6 цифр (например: МТ-145987, Х-258741)
- В ячейке всегда одно значение (не требуется обработка множественных значений)

### 3.3. Новые модули/функции

#### 3.3.1. Расширение `mdlHelper.bas`
**Новые функции:**
- `GetStaffDataByTableNumber(tableNumber As String) As Object` - поиск сотрудника по табельному номеру (колонка "Лицо")
- `FindEmployeeByAnyNumber(number As String) As Object` - универсальный поиск (сначала по личному номеру, затем по табельному)

#### 3.3.2. Расширение `mdlUniversalPaymentExport.bas`
**Новые функции:**
- `ImportEmployeesByNumbers()` - главная функция массового импорта
- `ProcessSelectedRangeForImport(wsPayments As Worksheet, selectedRange As Range) As String` - обработка выделенного диапазона и заполнение данных

#### 3.3.3. Форма `frmSelectEmployee.frm`
**Элементы:**
- `txtSearch` - поле ввода для поиска
- `lstResults` - список результатов (4 колонки: личный номер, ФИО, звание, должность)
- `lblStatus` - статус (количество найденных)
- `btnSelect` - кнопка "Выбрать"
- `btnCancel` - кнопка "Отмена"

**Свойства:**
- `selectedLichniyNomer As String` - выбранный личный номер (Public)
- `selectedFIO As String` - выбранное ФИО (Public)

#### 3.3.3. Обновление `mdlRibbonHandlers.bas`
**Новые обработчики:**
- `OnMassImportEmployeesClick()` - обработчик кнопки "Массовое добавление"
- `OnSelectEmployeeClick()` - обработчик кнопки "Выбрать сотрудника"

### 3.4. Обновление Ribbon XML
Добавить кнопки в группу "Надбавки":
- "Массовое добавление" - для массового импорта
- "Выбрать сотрудника" - для открытия формы поиска или при двойном щелчке по строке для открытия формы поиска нужной ФИО

## 4. Алгоритмы

### 4.1. Массовое добавление
```
1. Проверить, что активный лист = "Выплаты_Без_Периодов"
2. Получить выделенный диапазон (Selection)
3. Если диапазон пуст или не в колонке D - показать предупреждение
4. Для каждой ячейки в диапазоне:
   a. Извлечь значение (номер)
   b. Очистить от пробелов, переносов строк
   c. Если значение пусто - пропустить
   d. Найти сотрудника в листе "Штат" по номеру
   e. Если найден:
      - Заполнить колонку C (ФИО) в той же строке
      - Обновить колонку D (личный номер) - нормализовать формат
   f. Если не найден - добавить в список не найденных
5. Показать отчет: найдено X, не найдено Y
6. Автоматически пронумеровать колонку A для новых строк
```

### 4.2. Добавление через форму
```
1. Проверить активную ячейку (должна быть в колонке C или D)
2. Определить целевую строку
3. Открыть форму frmSelectEmployee
4. При выборе сотрудника:
   a. Заполнить колонку C (ФИО) в целевой строке
   b. Заполнить колонку D (личный номер) в целевой строке
5. Закрыть форму
```

## 5. Обработка ошибок

### 5.1. Массовое добавление
- **Ошибка:** Лист "Выплаты_Без_Периодов" не найден
  - **Действие:** Показать сообщение об ошибке, выйти из функции

- **Ошибка:** Выделенный диапазон не в колонке D
  - **Действие:** Показать предупреждение, предложить выбрать правильный диапазон

- **Ошибка:** Номер не найден в штате
  - **Действие:** Добавить в отчет, продолжить обработку остальных номеров

- **Ошибка:** Дублирование номеров
  - **Действие:** Обработать все вхождения, каждое независимо

### 5.2. Добавление через форму
- **Ошибка:** Активная ячейка не в колонке C или D
  - **Действие:** Показать предупреждение, не открывать форму

- **Ошибка:** Лист "Штат" не найден
  - **Действие:** Показать сообщение об ошибке, закрыть форму

## 6. Пользовательский интерфейс

### 6.1. Кнопки Ribbon
- **"Массовое добавление"**
  - Иконка: `PeopleAddToTeam` или `ImportExcel`
  - Размер: normal
  - Подсказка: "Массовое добавление сотрудников по номерам"
  - Детали: "Выделите ячейки с номерами в колонке D и нажмите для автоматического заполнения ФИО"

- **"Выбрать сотрудника"**
  - Иконка: `PeoplePicker` или `FindDialog`
  - Размер: normal
  - Подсказка: "Выбрать сотрудника из списка"
  - Детали: "Открывает форму поиска для выбора сотрудника и заполнения текущей строки"

### 6.2. Форма поиска
- Заголовок: "Выбор сотрудника"
- Размер: аналогичен `frmSearchFIO` (без полей, показывающих периоды, то есть строка поиска. строка с найденными ФИО и поля для вывода информации при одинарном клике по найденному результату)
- Поле поиска: вверху формы
- Список результатов: основной элемент формы
- Кнопки: "Выбрать" (по умолчанию), "Отмена"

## 7. Интеграция с существующим кодом

### 7.1. Использование существующих функций
- `mdlHelper.GetStaffData()` - для поиска сотрудника по личному номеру
- `mdlHelper.FindColumnNumbers()` - для определения колонок в листе "Штат"
- `mdlReferenceData.SHEET_PAYMENTS_NO_PERIODS` - константа имени листа
- `mdlPaymentValidation.COL_*` - константы колонок листа "Выплаты_Без_Периодов"

### 7.2. Зависимости
- `mdlHelper.bas` - для работы с данными штата
- `mdlReferenceData.bas` - для констант имен листов
- `mdlPaymentValidation.bas` - для констант колонок

## 8. Тестирование

### 8.1. Сценарии тестирования массового добавления
1. Добавление одного номера
2. Добавление нескольких номеров подряд
3. Добавление номеров с пропусками (пустые ячейки)
4. Обработка несуществующих номеров
5. Обработка дублирующихся номеров
6. Добавление в пустой лист
7. Добавление в лист с существующими данными

### 8.2. Сценарии тестирования формы поиска
1. Поиск по ФИО (полное совпадение)
2. Поиск по ФИО (частичное совпадение)
3. Поиск по личному номеру
4. Выбор сотрудника двойным кликом
5. Выбор сотрудника кнопкой "Выбрать"
6. Отмена выбора
7. Поиск при пустом результате

## 9. Уточнения (Ответы)

1. **Поддержка табельных номеров:** Да, необходима. Поиск по колонке "Лицо" с числовыми значениями.
2. **Множественные номера в ячейке:** Не требуется. В ячейке всегда одно значение.
3. **Перезапись ФИО:** Да, нужна возможность перезаписи уже заполненного ФИО.
4. **Формат личного номера:** 1-2 буквы + дефис + 6 цифр (например: МТ-145987, Х-258741). Валидация формата не обязательна - поиск выполняется по точному совпадению.
5. **Логирование:** Не требуется.

**Примечание:** По возможности использовать существующие модули, расширяя их функциональность, а не создавая новые модули.

---

**Статус:** Утверждена  
**Следующий этап:** Создание технического плана (Plan)
