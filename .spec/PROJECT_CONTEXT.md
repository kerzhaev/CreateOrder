# Project Context & Knowledge Base
> Этот файл — "мозг" проекта. Агент обязан читать его в начале каждой сессии и обновлять после завершения задач.

## 0. System Instructions (Agent Rules)
* **Encoding:** ВСЕГДА используй кодировку **Windows-1251** для всех файлов исходного кода VBA (`.bas`, `.cls`, `.frm`). Файлы `.md` и конфигурации хранятся в UTF-8.
* **VBA Standards:** Передавай пользовательские типы данных (UDT) только через **ByRef**.
* **UI/Forms:** Файлы форм (`.frm`) редактируются как текстовые документы. Бинарные файлы `.frx` запрещено изменять вручную — они должны оставаться нетронутыми.
* **Workflow:** Мы следуем Spec-Driven Development. Любое изменение кода начинается с обновления или создания спецификации в папке `.spec/tasks/`.
* **Context Maintenance:** После выполнения задачи Агент обязан обновить разделы `Active State` и `Log` в этом файле.

## 1. Глобальная цель
Разработка генератора приказов и QR-кодов для воинской части на базе Excel/VBA с использованием VbaModuleManager https://github.com/Rabadash8820/VbaModuleManager.

## 2. Текущее состояние (Active State)
* **Версия:** 1.4.1
* **Текущая задача:** Реорганизация структуры проекта и внедрение Spec-kit v0.0.95.
* **Активная спецификация:** `.spec/tasks/reorganization.md`
* **Текущий статус:** Проект настроен, исправлены все ошибки компиляции, идет переход на агентскую структуру работы.

## 3. Архитектурные решения (ADR)
* [2025-12-28] Используем кодировку Windows-1251 для всех файлов кода (кроме документов .md).
* [2025-12-28] Формы храним в формате .frm, бинарные файлы .frx не редактируем руками.
* [2025-12-28] Используем Spec-Driven Development (Spec -> Plan -> Code).

## 4. Карта модулей (Module Map)

 *каталог workbook-modules - МОДУЛИ листов
 *каталог resources - customUI14.xml - пользовательская лента команд

### 4.1. Основные модули экспорта документов
* `mdlMainExport.bas` — Экспорт основного приказа с заполнителями.
* `mdlRaportExport.bas` — Экспорт рапортов в Word по шаблонам.
* `mdlSpravkaExport.bas` — Экспорт справок о нахождении в зоне СВО.
* `mdlRiskExport.bas` — Формирование приказа о надбавке за риск (2% в день).
* `mdlFRPExport.bas` — Формирование Excel-отчётов: ДСО и ФРП Риск.
* `mdlUniversalPaymentExport.bas` — Универсальный экспорт надбавок, включает массовый импорт сотрудников.

### 4.2. Модули работы с данными
* `mdlDataImport.bas` — Импорт данных на лист "Штат".
* `mdlDataValidation.bas` — Валидация данных и проверка периодов.
* `mdlPaymentValidation.bas` — Валидация надбавок без периодов.
* `mdlReferenceData.bas` — Работа со справочниками системы надбавок.

### 4.3. Вспомогательные и Системные модули
* `mdlHelper.bas` — Общие функции, поиск по личному и табельному номеру.
* `mdlRibbonHandlers.bas` — Обработчики событий пользовательской ленты (Ribbon).
* `modActivation.bas` — Лицензирование и активация.
* `MdlBackup.bas` — Создание резервных копий (снапшотов) проекта.

### 4.4. Пользовательские формы (UserForms)
* `frmSearchFIO.frm` — Автоматизированный поиск и внесение периодов.
* `frmSelectEmployee.frm` — Форма выбора сотрудника с поиском по ФИО и номерам.

## 5. История изменений (Log)
- **v.1.4.1**: Внедрен Spec Kit, настроен .gitignore, .cursorrules.
- **2025-01-02**: Исправлены ошибки компиляции: убраны лишние префиксы `mdlHelper`, введено использование `Dictionary` для хранения UDT в коллекциях, исправлены `ByVal` на `ByRef` для параметров типа `PaymentTypeConfig`.
- **2025-01-02 (upd)**: Реализована логика экспорта надбавок в единый документ и поддержка всех маркеров шаблона (`[ФИО]`, `[ЗВАНИЕ]` и т.д.).
- **2025-01-02 (upd)**: Добавлен массовый импорт сотрудников по личным и табельным номерам с автоматическим заполнением данных.