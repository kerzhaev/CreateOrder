# Project Context & Knowledge Base
> Этот файл — "мозг" проекта. Агент обязан читать его в начале сессии и обновлять после завершения задач.

## 1. Глобальная цель
Разработка генератора приказов и QR-кодов для воинской части на базе Excel/VBA с использованием VbaModuleManager.

## 2. Текущее состояние (Active State)
*   **Версия:** 1.4.1
*   **Последняя задача:** �справление ошибок компиляции VBA проекта.
*   **Текущий статус:** Проект настроен, исправлены все ошибки компиляции, готов к разработке функционала.

## 3. Архитектурные решения (ADR)
*   *Здесь мы записываем важные решения, чтобы не забыть.*
*   [2025-12-28] Использем кодировку Windows-1251 для всех файлов(за исключением файлов .md).
*   [2025-12-28] Формы храним как .frm, бинарные .frx не трогаем руками.
*   [2025-12-28] Используем Spec-Driven Development (Spec -> Plan -> Code).

## 4. Карта модулей (Module Map)

### 4.1. Основные модули экспорта документов
*   `mdlMainExport.bas` — Экспорт основного приказа с заполнителями для отсутствующих сотрудников.
*   `mdlRaportExport.bas` — Экспорт рапортов в Word на основе шаблона.
*   `mdlSpravkaExport.bas` — Экспорт справок о нахождении в зоне СВО.
*   `mdlRiskExport.bas` — Формирование приказа о надбавке за риск (2% в день, макс 60% в месяц).
*   `mdlFRPExport.bas` — Формирование Excel-отчётов: ДСО (сутки отдыха) и ФРП Риск.
*   `mdlUniversalPaymentExport.bas` — Универсальный экспорт надбавок без периодов в Word.

### 4.2. Модули работы с данными
*   `mdlDataImport.bas` — Импорт данных на лист "Штат" из внешнего Excel файла.
*   `mdlDataValidation.bas` — Валидация данных основного листа и проверка периодов.
*   `mdlPaymentValidation.bas` — Валидация надбавок без периодов.
*   `mdlReferenceData.bas` — Работа со справочниками для системы надбавок без периодов.

### 4.3. Модули конфигурации и типов
*   `mdlPaymentTypes.bas` — Конфигурация типов выплат для системы надбавок без периодов.

### 4.4. Вспомогательные модули
*   `mdlHelper.bas` — Универсальные вспомогательные функции и процедуры для использования во всех частях проекта.

### 4.5. Модули интерфейса
*   `mdlRibbonHandlers.bas` — Обработчики событий пользовательской ленты (Ribbon).

### 4.6. Системные модули
*   `modActivation.bas` — Лицензирование с триальным периодом 365 дней и активацией.
*   `MdlBackup.bas` — Создание резервных копий VBA проекта (снапшоты).
*   `MdlClearCash.bas` — Очистка кэша Office и восстановление ribbon.

### 4.7. Пользовательские формы (UserForms)
*   `frmAbout.frm` — Форма информации о программе и активации макроса.
*   `frmSearchFIO.frm` — Автоматизированная форма поиска и внесения периодов для военнослужащего.

## 5. История изменений (Log)
- **v.1.4.1**: Внедрен Spec Kit, настроен .gitignore, .cursorrules.
- **2025-01-02**: �справлены ошибки компиляции VBA проекта:
    *   **Ошибка с `mdlHelper` в форме `frmSearchFIO`**: Убраны префиксы `mdlHelper.` из всех вызовов, так как `Public` переменные и процедуры доступны без префикса модуля.
    *   **Ошибка с `ByVal` для пользовательских типов**: �справлены функции `GetTemplatePathWithFallback`, `FillPaymentTemplate`, `GeneratePaymentTextDirectly` — изменено `ByVal` на `ByRef` для параметров типа `PaymentTypeConfig` и `PaymentWithoutPeriod`.
    *   **Ошибка с добавлением UDT в Collection**: �"обавлены вспомогательные функции `PaymentToDictionary` и `DictionaryToPayment` в модуле `mdlUniversalPaymentExport.bas` для преобразования пользовательского типа `PaymentWithoutPeriod` в `Dictionary` и обратно. �спользуется для хранения UDT в `Collection` через промежуточное преобразование.
    *   Обновлены функции `CollectPaymentsData`, `GroupPaymentsByType`, `GeneratePaymentOrder` для использования новых функций преобразования.
- **2025-01-02 (продолжение)**: Добавлены обработчики для кнопок Ribbon и исправлена логика экспорта надбавок:
    *   **Добавлены обработчики Ribbon в `mdlRibbonHandlers.bas`**:
        *   `OnExportAllowancesClick` — обработчик кнопки "Экспорт надбавок" (вызывает `mdlUniversalPaymentExport.ExportPaymentsWithoutPeriods`)
        *   `OnValidateAllowancesClick` — обработчик кнопки "Проверить надбавки" (вызывает `mdlPaymentValidation.ValidatePaymentsWithoutPeriods`)
        *   `OnManageReferencesClick` — обработчик кнопки "Справочники" (открывает лист справочников)
    *   **Исправлена логика экспорта в `mdlUniversalPaymentExport.bas`**:
        *   Изменена функция `GeneratePaymentOrder` — теперь создается **один приказ** для всех записей из таблицы "Выплаты_Без_Периодов"
        *   Для каждой записи открывается шаблон, заменяются маркеры данными записи, содержимое копируется и добавляется в общий документ
        *   Между записями добавляется пустая строка для разделения
        *   Итоговый документ сохраняется с именем `Приказ_[Тип_Выплаты]_[дата].docx`
    *   **Поддержка маркеров в шаблоне**:
        *   Функция `FillPaymentTemplate` поддерживает все маркеры: `[ФИО]`, `[ФИО_ИМЕНИТЕЛЬНЫЙ]`, `[ЗВАНИЕ]`, `[ЗВАНИЕ_СКЛОНЕННОЕ]`, `[ЛИЧНЫЙ_НОМЕР]`, `[ДОЛЖНОСТЬ]`, `[ДОЛЖНОСТЬ_СКЛОНЕННАЯ]`, `[РАЗМЕР]`, `[ОСНОВАНИЕ]`