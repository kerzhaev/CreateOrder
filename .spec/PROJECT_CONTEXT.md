# Project Context & Knowledge Base
> Этот файл — "мозг" проекта. Агент обязан читать его в начале каждой сессии и обновлять после завершения задач.

## 0. System Instructions (Agent Rules)
* **Encoding:** ВСЕГДА используй кодировку **Windows-1251** для всех файлов исходного кода VBA (`.bas`, `.cls`, `.frm`). Файлы `.md` и конфигурации хранятся в UTF-8.
* **VBA Standards:** Передавай пользовательские типы данных (UDT) только через **ByRef**.
* **UI/Forms:** Файлы форм (`.frm`) редактируются как текстовые документы. Бинарные файлы `.frx` запрещено изменять вручную — они должны оставаться нетронутыми.
* **Workflow:** Мы следуем Spec-Driven Development. Любое изменение кода начинается с обновления или создания спецификации в папке `.spec/tasks/`.
* **Context Maintenance:** После выполнения задачи Агент обязан обновить разделы `Active State` и `Log` в этом файле.

## 1. Глобальная цель
Разработка генератора приказов и QR-кодов для воинской части на базе Excel/VBA с использованием VbaModuleManager https://github.com/Rabadash8820/VbaModuleManager.

## 2. Текущее состояние (Active State)
* **Версия:** 1.7.0 (Word Raport Import & Smart Ribbon)
* **Текущий статус:** Стабильно. Внедрён ETL-пайплайн импорта рапортов из Word. Редизайн ленты с «умной» кнопкой валидации.
* **В работе:** Licensing v2 (Time-Bomb & Admin Panel) — гибридная система лицензирования с трехуровневой проверкой даты и скрытой админ-панелью. См. `.spec/tasks/feature-licensing-v2/`.

## 3. Архитектурные решения (ADR)
* [2025-12-28] Используем кодировку Windows-1251 для всех файлов кода (кроме документов .md).
* [2025-12-28] Формы храним в формате .frm, бинарные файлы .frx не редактируем руками.
* [2025-12-28] Используем Spec-Driven Development (Spec -> Plan -> Code).

## 4. Карта модулей (Module Map)

 *каталог workbook-modules - МОДУЛИ листов
 *каталог resources - customUI14.xml - пользовательская лента команд

### 4.1. Основные модули экспорта документов
* `mdlMainExport.bas` — Экспорт основного приказа с заполнителями.
* `mdlRaportExport.bas` — Экспорт рапортов в Word по шаблонам.
* `mdlSpravkaExport.bas` — Экспорт справок о нахождении в зоне СВО.
* `mdlRiskExport.bas` — Формирование приказа о надбавке за риск (2% в день).
* `mdlFRPExport.bas` — Формирование Excel-отчётов: ДСО и ФРП Риск.
* `mdlUniversalPaymentExport.bas` — Универсальный экспорт надбавок, включает массовый импорт сотрудников.

### 4.2. Модули работы с данными
* `mdlDataImport.bas` — Импорт данных на лист "Штат".
* `mdlDataValidation.bas` — Валидация данных и проверка периодов.
* `mdlPaymentValidation.bas` — Валидация надбавок без периодов.
* `mdlReferenceData.bas` — Работа со справочниками системы надбавок.
* `mdlWordImport.bas` — Импорт периодов СВО из утвержденных Word-документов через HTML-конвертацию и работу с Dictionary.

### 4.3. Вспомогательные и Системные модули
* `mdlHelper.bas` — Общие функции, поиск по личному и табельному номеру.
* `mdlRibbonHandlers.bas` — Обработчики событий пользовательской ленты (Ribbon).
* `modActivation.bas` — Лицензирование и активация.
* `MdlBackup.bas` — Создание резервных копий (снапшотов) проекта.

### 4.4. Пользовательские формы (UserForms)
* `frmSearchFIO.frm` — Автоматизированный поиск и внесение периодов.
* `frmSelectEmployee.frm` — Форма выбора сотрудника с поиском по ФИО и номерам.

## 5. История изменений (Log)
- **v.1.7.0 (23.02.2026):**
  - **UX/UI (mdlHelper):** Улучшена информативность ошибок при поиске столбцов в листе "Штат". Теперь функция FindColumnNumbers выводит подробное диалоговое окно с указанием конкретных отсутствующих столбцов. Система стала "умнее": макрос распознает различные варианты заголовков ("ФИО", "Фамилия", "Табельный номер", "Звание", "Должность").
  - **Fix (Memory Leak):** Добавлено принудительное закрытие фоновых процессов Excel (wb.Close False) в модулях выгрузок Алушта (mdlFRPExport) и импорте рапортов (mdlWordImport). Теперь программа не плодит пустые файлы (призрачные окна) при генерации отчетов и корректно высвобождает память при перехвате ошибок.
  - **UX/UI (frmAbout):** Реализована возможность заблаговременной активации (Proactive Activation). Теперь поле для ввода персонального ключа отображается и во время действия бесплатного периода, позволяя пользователям активировать программу до ее блокировки.
  - **UX/UI (Ribbon):** Кнопка 'Диагностика' заменена на кнопку 'О программе' (иконка Info) в группе 'Проверка и Настройки' для быстрого доступа к информации о лицензии и HWID. Обновлены обработчики ленты (mdlRibbonHandlers).

  - **Fix (mdlDataImport):** Исправлен баг "Ошибка 0" при импорте данных штата. Удален вызов метода .Select неактивного листа, а в блоке ErrorHandler реализовано предварительное сохранение Err.Number и Err.Description до вызова On Error GoTo 0.
  - **Feature (mdlWordImport):** Внедрен надежный ETL-пайплайн для импорта периодов СВО из утвержденных рапортов (Word). Таблицы конвертируются в HTML и загружаются в словарь с группировкой по Личному номеру и автоматической хронологической сортировкой.
  - **UX/UI (Ribbon & mdlRibbonHandlers):** Проведен редизайн ленты. Внедрена «умная» кнопка валидации (RunSmartValidation), которая автоматически определяет активный лист (ДСО или Надбавки) и запускает нужную проверку. Исправлены системные иконки imageMso.
- **v.1.6.0 (17.02.2026):**
  - **Licensing (modActivation):** Внедрена функция `CheckLicenseAndPrompt`. Реализован механизм "Freemium" (базовые функции доступны, экспорт блокируется).
  - **UI (frmAbout):** Обновлен интерфейс окна активации. Добавлены понятные статусы ("Ограниченная версия", "Активировано") и инструкции.
  - **Ribbon (mdlRibbonHandlers):** Установлены "ловушки" проверки лицензии на кнопки экспорта (Word/Excel).
- **v.1.5.9 (17.02.2026):**
  - **Refactor (mdlHelper):** Внедрён «Умный парсер должностей» (Smart Position Parser) с логикой Head/Body/Tail на базе `VBScript.RegExp`.
  - **Feature:** Добавлена градация обрезки наименований подразделений. Процедура `GetSettingCutBattalion` читает лист «Настройки» (ячейка B2) для условной обрезки внутренних батальонов.
  - **Fix:** Исправлена синтаксическая ошибка в `ParseDateSafe` (разнесён однострочный If/ElseIf).
  - **Restoration:** Восстановлены утраченные функции поиска (`GetStaffData`, `InitStaffColumnIndexes`) и утилиты Word.
  - **Setup:** Добавлена процедура `SetupSettingsSheet` для автоматического создания листа конфигурации.
- **v.1.5.2 (UI & Security Update)**:
  - **UI Поиска (frmSearchFIO):** Внедрен многоколоночный список результатов (5 колонок: ID, ФИО, Звание, Должность, Часть). Реализован "живой поиск" и навигация с клавиатуры (стрелки, Enter).
  - **Лицензирование (modActivation.bas):** Исправлена ошибка Type Mismatch при генерации ключей (переход на DateSerial). Внедрена защита от отката системного времени.
  - **Рефакторинг:** Удалены лишние обращения к `vbTab` в поиске, переход на честные колонки ListBox.
- **v.1.5.1 (Alushta Update)**:
  - **Интерфейс (customUI14.xml):** Кнопка "Сводный отчет" переименована в "Выгрузка Алушта/ФРП".
  - **Экспорт (mdlFRPExport.bas):** В отчеты (ДСО и Риск) добавлен столбец "Табельный номер" (4-я колонка). Данные подтягиваются из столбца "Лицо" листа "Штат" (выбирается тот столбец, который содержит цифровые значения).
- **v.1.5.0 (Licensing Update)**:
  - **Рефакторинг ядра (mdlHelper.bas):** FIO Engine — новая логика склонения ФИО (`UDFs_FIO`) на основе словарей имён; старые `SklonitFamiliya` заменены на обёртку `FIO(name, "Case")`. Date Parsing — переписана `ParseDateSafe`, исправлена ошибка «1899 года» при 2-значных годах (напр. «25» → 2025). RegExp — добавлен движок через Late Binding (`RegExpExtract`, `RegExpMatch`).
  - **Лицензирование (modActivation.bas, frmAbout):** Полная замена модуля на оффлайн-валидацию с проверкой даты окончания. Формат ключа: `XXXX-XXXX-XXXX-XXXX` (Соль, Шифрованная Дата, Шум, Хэш). В `frmAbout` — авто-форматирование ввода (авто-тире), блокировка кириллицы и спецсимволов.
  - **Интерфейс (customUI14.xml):** Редизайн вкладки «СВО Макросы»; кнопки надбавок (Экспорт, Валидация, Справочники) сгруппированы в `<menu>`. Иконки заменены на Legacy-набор (`FileSaveAs`, `Spelling`, `FindDialog`) для Excel 2010+.
  - **Валидация и экспорт:** В `mdlPaymentValidation` — мягкая проверка для «Водителей СдЕ» (достаточно одного совпадения: ВАИ, ВУ, Приказ или Марка). В `mdlRibbonHandlers` — выбор типа рапорта (ДСО или Риск).
- **v.1.4.1**: Внедрен Spec Kit, настроен .gitignore, .cursorrules.
- **2025-01-02**: Исправлены ошибки компиляции: убраны лишние префиксы `mdlHelper`, введено использование `Dictionary` для хранения UDT в коллекциях, исправлены `ByVal` на `ByRef` для параметров типа `PaymentTypeConfig`.
- **2025-01-02 (upd)**: Реализована логика экспорта надбавок в единый документ и поддержка всех маркеров шаблона (`[ФИО]`, `[ЗВАНИЕ]` и т.д.).
- **2025-01-02 (upd)**: Добавлен массовый импорт сотрудников по личным и табельным номерам с автоматическим заполнением данных.